function d(n,r){if("."===r)return n[n.length-1];r=r.split(".");for(let t=n.length-1;0<=t;t--){let e=n[t];for(let t=0;t<r.length&&"object"==typeof e;t++)if(e.hasOwnProperty(r[t])&&(e=e[r[t]],t===r.length-1))return e}}function c(n,r,i,s,l){var o=[];let a=0;for(;a<n.length;){var t=n.indexOf(r,a);if(-1===t){o.push(n.substring(a,n.length));break}var u=n.substring(a,t),u=(0<u.length&&o.push(u),n.indexOf(i,t+r.length));if(-1===u)throw`Found open tag at position ${t} but found no close tag`;let e=n.substring(t+r.length,u).trim();if(a=u+i.length,e.startsWith("!"))console.debug("Comment",e.substring(1).trim());else if(e.startsWith("#")||e.startsWith("^")){var t=e.startsWith("^"),{stopTagIndex:u,nextCurrentIndex:h}=(e=e.substring(1).trim(),function(e,n,r,i,t){let s=t;for(var l=[];s<e.length;){var o=e.indexOf(n,s);if(-1===o)return;var a=e.indexOf(r,o+n.length);if(-1===a)throw"Could not find close index";let t=e.substring(o+n.length,a);if(t.startsWith("#")||t.startsWith("^"))t=t.substring(1).trim(),l.push(t);else if(t.startsWith("/")){if(t=t.substring(1).trim(),0===l.length&&t===i)return{stopTagIndex:o,nextCurrentIndex:a+r.length};o=l.pop();if(o!==t)throw`Found end tag for ${t} when expecting `+o}s=a+r.length}}(n,r,i,e,a));if(-1===u)throw"Could not find end tag for "+e;var g=d(l,e),f=null==g||!1===g;if(t&&f)void 0!==g&&l.push(g),o.push(c(n.substring(a,u),r,i,s,l)),void 0!==g&&l.pop();else if(!t&&!f)if(Array.isArray(g)){var p=n.substring(a,u);for(let t=0;t<g.length;t++)l.push(g[t]),o.push(c(p,r,i,s,l)),l.pop()}else"function"==typeof g?o.push(g.call(null,n.substring(a,u),t=>c(t,r,i,s,l))):(l.push(g),o.push(c(n.substring(a,u),r,i,s,l)),l.pop());a=h}else{if(e.startsWith("/"))throw"Encountered unexpected end tag "+(e=e.substring(1).trim());if(e.startsWith(">")){e=e.substring(1).trim();t=s.call(null,e);o.push(c(t,r,i,s,l))}else if(e.startsWith("=")&&e.endsWith("=")){f=e.substring(1,e.length-1).trim().match(/^([^ =]+)[ ]+([^ =]+)$/);if(!f)throw"Expected new tags but could not find them";r=f[1],i=f[2]}else{let t=!0;e.startsWith("&")?(t=!1,e=e.substring(1).trim()):e.startsWith(r.charAt(0))&&n.charAt(a)===i.charAt(i.length-1)&&(t=!1,e=e.substring(1).trim(),a++);u=d(l,e);void 0!==u&&(h=""+("function"==typeof u?u.call(null):u),t?o.push(h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")):o.push(h))}}}return o.join("")}export default function(t){if(null==t)throw"No options or template defined";let e;if("string"==typeof t?(e=t,t={}):e=t.template,!e)throw"Template not defined";var n=t.open||"{{",r=t.close||"}}",i=t.partialLookup||(t=>{var e=document.getElementById(t);if(e)return e.innerText;throw`Could not find element with id ${t} to use as partial`}),t=t.dataStack||[t.data||{}];if(Array.isArray(t))return c(e,n,r,i,t);throw"Data stack is not a stack"}