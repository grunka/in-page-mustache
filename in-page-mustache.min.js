function c(n,r){if("."===r)return n[n.length-1];r=r.split(".");for(let t=n.length-1;0<=t;t--){let e=n[t];for(let t=0;t<r.length&&"object"==typeof e;t++)if(e.hasOwnProperty(r[t])&&(e=e[r[t]],t===r.length-1))return e}}function b(n,r,i,s,o,l){var a=[];let u=0;for(;u<n.length;){var t=n.indexOf(r,u);if(-1===t){a.push(n.substring(u,n.length));break}var h=n.substring(u,t),h=(0<h.length&&a.push(h),n.indexOf(i,t+r.length));if(-1===h)throw`Found open tag at position ${t} but found no close tag`;let e=n.substring(t+r.length,h).trim();if(u=h+i.length,e.startsWith("!"))console.debug("Comment",e.substring(1).trim());else if(e.startsWith("#")||e.startsWith("^")){var t=e.startsWith("^"),{stopTagIndex:h,nextCurrentIndex:g}=(e=e.substring(1).trim(),function(e,n,r,i,t){let s=t;for(var o=[];s<e.length;){var l=e.indexOf(n,s);if(-1===l)return;var a=e.indexOf(r,l+n.length);if(-1===a)throw"Could not find close index";let t=e.substring(l+n.length,a);if(t.startsWith("#")||t.startsWith("^"))t=t.substring(1).trim(),o.push(t);else if(t.startsWith("/")){if(t=t.substring(1).trim(),0===o.length&&t===i)return{stopTagIndex:l,nextCurrentIndex:a+r.length};l=o.pop();if(l!==t)throw`Found end tag for ${t} when expecting `+l}s=a+r.length}}(n,r,i,e,u));if(-1===h)throw"Could not find end tag for "+e;var f=c(l,e),p=null==f||!1===f;if(t&&p)void 0!==f&&l.push(f),a.push(b(n.substring(u,h),r,i,s,void 0,l)),void 0!==f&&l.pop();else if(!t&&!p)if(Array.isArray(f)){var d=n.substring(u,h);for(let t=0;t<f.length;t++)l.push(f[t]),a.push(b(d,r,i,s,void 0,l)),l.pop()}else"function"==typeof f?a.push(f.call(null,n.substring(u,h),t=>b(t,r,i,s,void 0,l))):(l.push(f),a.push(b(n.substring(u,h),r,i,s,void 0,l)),l.pop());u=g}else{if(e.startsWith("/"))throw"Encountered unexpected end tag "+(e=e.substring(1).trim());if(e.startsWith(">")){e=e.substring(1).trim();t=s.call(null,e);a.push(b(t,r,i,s,void 0,l))}else if(e.startsWith("=")&&e.endsWith("=")){p=e.substring(1,e.length-1).trim().match(/^([^ =]+)[ ]+([^ =]+)$/);if(!p)throw"Expected new tags but could not find them";r=p[1],i=p[2]}else{let t=o;e.startsWith("&")?(t=!1,e=e.substring(1).trim()):e.startsWith(r.charAt(0))&&n.charAt(u)===i.charAt(i.length-1)&&(t=!1,e=e.substring(1).trim(),u++);h=c(l,e);void 0!==h&&(g=""+("function"==typeof h?h.call(null):h),t?a.push(g.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")):a.push(g))}}}return a.join("")}export default function(t){if(null==t)throw"No options or template defined";let e;if("string"==typeof t?(e=t,t={}):e=t.template,!e)throw"Template not defined";var n=t.open||"{{",r=t.close||"}}",i=t.partialLookup||(t=>{var e=document.getElementById(t);if(e)return e.innerText;throw`Could not find element with id ${t} to use as partial`}),s=t.dataStack||[t.data||{}];if(Array.isArray(s))return t=t.escapeHtml||!0,b(e,n,r,i,t,s);throw"Data stack is not a stack"}